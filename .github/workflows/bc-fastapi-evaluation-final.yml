# .github/workflows/bc-fastapi-evaluation.yml
# Sistema de evaluaciÃ³n automÃ¡tica para el bootcamp bc-fastapi
# VersiÃ³n final optimizada

name: ğŸ¯ EvaluaciÃ³n bc-fastapi

on:
  repository_dispatch:
    types: [student-submission]
  workflow_dispatch:
    inputs:
      student_repo:
        description: 'Repositorio del estudiante (usuario/repo)'
        required: true
        type: string
      pr_number:
        description: 'NÃºmero del Pull Request'
        required: true
        type: string
      week_number:
        description: 'NÃºmero de semana (1-11)'
        required: false
        type: string
        default: '1'

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read
  actions: write

jobs:
  evaluate-submission:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repositorio bc-fastapi
        uses: actions/checkout@v4
        with:
          path: bc-fastapi-main

      - name: ğŸ” Configurar contexto de evaluaciÃ³n
        id: context
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            STUDENT_REPO="${{ github.event.client_payload.repository }}"
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
            WEEK_NUMBER="${{ github.event.client_payload.week_number }}"
          else
            STUDENT_REPO="${{ github.event.inputs.student_repo }}"
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            WEEK_NUMBER="${{ github.event.inputs.week_number }}"
          fi

          STUDENT_NAME=$(echo "$STUDENT_REPO" | cut -d'/' -f1)

          echo "student_repo=$STUDENT_REPO" >> $GITHUB_OUTPUT
          echo "student_name=$STUDENT_NAME" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "week_number=${WEEK_NUMBER:-1}" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Evaluando: $STUDENT_NAME - Semana ${WEEK_NUMBER:-1}"

      - name: ğŸ“¥ Clonar repositorio del estudiante
        run: |
          STUDENT_REPO="${{ steps.context.outputs.student_repo }}"

          echo "ğŸ”„ Clonando repositorio: $STUDENT_REPO"
          git clone "https://github.com/$STUDENT_REPO.git" student-repo || {
            echo "âŒ Error al clonar repositorio"
            exit 1
          }

          echo "âœ… Repositorio clonado exitosamente"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Instalar dependencias
        run: |
          pip install --upgrade pip
          pip install fastapi pydantic requests
          echo "âœ… Dependencias instaladas"

      - name: ğŸ“ Copiar script evaluador
        run: |
          cp bc-fastapi-main/_scripts/evaluation-system/bc_fastapi_evaluator.py ./
          chmod +x bc_fastapi_evaluator.py
          echo "âœ… Script evaluador preparado"

      - name: ğŸ” Ejecutar evaluaciÃ³n
        run: |
          python bc_fastapi_evaluator.py
        env:
          STUDENT_NAME: ${{ steps.context.outputs.student_name }}
          WEEK_NUMBER: ${{ steps.context.outputs.week_number }}

      - name: ğŸ“Š Mostrar resumen de evaluaciÃ³n
        run: |
          echo "ğŸ¯ RESUMEN DE EVALUACIÃ“N"
          echo "========================"
          echo "ğŸ‘¤ Estudiante: ${{ steps.context.outputs.student_name }}"
          echo "ğŸ“… Semana: ${{ steps.context.outputs.week_number }}"
          echo "ğŸ”— Repositorio: ${{ steps.context.outputs.student_repo }}"
          echo ""

          if [ -f "evaluation_report.md" ]; then
            echo "âœ… EvaluaciÃ³n completada"
            
            if grep -q "CalificaciÃ³n:" evaluation_report.md; then
              SCORE_LINE=$(grep "CalificaciÃ³n:" evaluation_report.md | head -1)
              echo "ğŸ“Š $SCORE_LINE"
            fi
            
            echo ""
            echo "ğŸ“‹ Ver detalles completos en los artifacts del workflow"
          else
            echo "âŒ Error en la evaluaciÃ³n - No se generÃ³ reporte"
            exit 1
          fi

      - name: ğŸ“¤ Subir resultados como artifacts
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results-${{ steps.context.outputs.student_name }}-week-${{ steps.context.outputs.week_number }}
          path: |
            evaluation_report.md
            analysis_result.json
          retention-days: 90

      - name: âœ… EvaluaciÃ³n completada
        run: |
          echo "ğŸ‰ EVALUACIÃ“N FINALIZADA"
          echo "========================"
          echo "âœ… Reporte generado: evaluation_report.md"
          echo "âœ… AnÃ¡lisis tÃ©cnico: analysis_result.json" 
          echo "âœ… Artifacts subidos para revisiÃ³n"
          echo ""
          echo "ğŸ“ Los resultados estÃ¡n disponibles en los artifacts de este workflow"
          echo "ğŸ”— URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # Job opcional para crear issue (requiere configuraciÃ³n adicional)
  create-feedback-issue:
    needs: evaluate-submission
    if: ${{ success() && vars.CREATE_FEEDBACK_ISSUES == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: â¬‡ï¸ Descargar resultados de evaluaciÃ³n
        uses: actions/download-artifact@v4
        with:
          name: evaluation-results-${{ needs.evaluate-submission.steps.context.outputs.student_name }}-week-${{ needs.evaluate-submission.steps.context.outputs.week_number }}

      - name: ğŸ“ Crear issue de feedback (opcional)
        uses: actions/github-script@v7
        env:
          STUDENT_REPO: ${{ needs.evaluate-submission.steps.context.outputs.student_repo }}
          WEEK_NUMBER: ${{ needs.evaluate-submission.steps.context.outputs.week_number }}
        with:
          github-token: ${{ secrets.STUDENT_REPOS_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            try {
              if (!fs.existsSync('evaluation_report.md')) {
                console.log('âŒ No se encontrÃ³ el reporte de evaluaciÃ³n');
                return;
              }
              
              const evaluation = fs.readFileSync('evaluation_report.md', 'utf8');
              const studentRepo = process.env.STUDENT_REPO;
              const weekNumber = process.env.WEEK_NUMBER;
              
              if (!studentRepo || !studentRepo.includes('/')) {
                console.log('âš ï¸ Formato de repositorio invÃ¡lido');
                return;
              }
              
              const [owner, repo] = studentRepo.split('/');
              
              const issueTitle = `ğŸ“‹ EvaluaciÃ³n Semana ${weekNumber} - Feedback AutomÃ¡tico`;
              const issueBody = evaluation + '\n\n---\n\n' +
                '## ğŸ¯ PrÃ³ximos Pasos\n\n' +
                '### âœ… Si tu calificaciÃ³n fue satisfactoria:\n' +
                '- ğŸ‰ Â¡Felicidades! ContinÃºa con la siguiente semana\n' +
                '- ğŸ“š Revisa las sugerencias de mejora para optimizar tu cÃ³digo\n\n' +
                '### ğŸ”„ Si necesitas mejoras:\n' +
                '- ğŸ“– Implementa las correcciones sugeridas\n' +
                '- ğŸ’» Revisa el material de la semana en el repositorio principal\n' +
                '- ğŸ’¬ Comenta en este issue si tienes dudas especÃ­ficas\n\n' +
                '---\n\n' +
                'ğŸ¤– *Issue creado automÃ¡ticamente por el sistema bc-fastapi*';

              const issue = await github.rest.issues.create({
                owner: owner,
                repo: repo,
                title: issueTitle,
                body: issueBody,
                labels: ['evaluacion-automatica', `semana-${weekNumber}`, 'bc-fastapi']
              });
              
              console.log(`âœ… Issue de feedback creado: ${issue.data.html_url}`);
              
            } catch (error) {
              console.log(`âš ï¸ No se pudo crear el issue: ${error.message}`);
              console.log('Esto es normal si no tienes permisos configurados para el repositorio del estudiante');
            }
